---
title: "Single-Cell RNA-seq Analysis Report"
author: "Bioinformatics Core"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: true
    theme: flatly
    fig-width: 10
    fig-height: 6
jupyter: python3
params:
  input_file: "adata.h5ad"
  n_top_genes: 2000
---

## Overview

This report presents single-cell RNA-seq analysis results.

```{python}
#| label: setup
#| include: false

import scanpy as sc
import matplotlib.pyplot as plt
import pandas as pd
import numpy as np

sc.settings.verbosity = 0
sc.settings.set_figure_params(dpi=100, frameon=False)
```

## Data Loading

```{python}
#| label: load-data

adata = sc.read_h5ad('adata.h5ad')
print(f"Cells: {adata.n_obs:,}")
print(f"Genes: {adata.n_vars:,}")
```

## Quality Control {.panel-tabset}

### QC Metrics

```{python}
#| label: fig-qc
#| fig-cap: "Quality control metrics"

sc.pl.violin(adata, ['n_genes_by_counts', 'total_counts', 'pct_counts_mt'],
             jitter=0.4, multi_panel=True)
```

### Filtering Summary

```{python}
#| label: tbl-filtering
#| tbl-cap: "Filtering statistics"

qc_stats = pd.DataFrame({
    'Metric': ['Total cells', 'Median genes/cell', 'Median counts/cell'],
    'Value': [adata.n_obs,
              int(np.median(adata.obs['n_genes_by_counts'])),
              int(np.median(adata.obs['total_counts']))]
})
qc_stats
```

## Dimensionality Reduction

```{python}
#| label: fig-umap
#| fig-cap: "UMAP embedding colored by cluster"

sc.pl.umap(adata, color='leiden', legend_loc='on data')
```

## Cluster Markers {.panel-tabset}

### Dotplot

```{python}
#| label: fig-markers
#| fig-cap: "Marker gene expression"

marker_genes = ['CD3D', 'CD14', 'CD19', 'NKG7', 'FCGR3A']
sc.pl.dotplot(adata, marker_genes, groupby='leiden', standard_scale='var')
```

### Heatmap

```{python}
#| label: fig-heatmap
#| fig-cap: "Top marker genes per cluster"
#| fig-height: 8

sc.tl.rank_genes_groups(adata, 'leiden', method='wilcoxon')
sc.pl.rank_genes_groups_heatmap(adata, n_genes=5, show_gene_labels=True)
```

## Cell Type Distribution

```{python}
#| label: fig-composition
#| fig-cap: "Cell type composition"

cell_counts = adata.obs['leiden'].value_counts()
plt.figure(figsize=(10, 6))
cell_counts.plot(kind='bar')
plt.xlabel('Cluster')
plt.ylabel('Number of cells')
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()
```

::: {.callout-note}
Cluster annotations should be validated with known marker genes.
:::

## Session Info

```{python}
#| label: session-info

print(f"Scanpy version: {sc.__version__}")
print(f"AnnData shape: {adata.shape}")
```
